<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deriv Signals — Live 1-Tick</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  :root{--bg:#071128;--card:#0f1724;--muted:#94a3b8;--accent:#10b981;--danger:#ef4444}
  body{background:linear-gradient(180deg,#030412 0%,var(--bg) 100%);color:#e6eef8;font-family:Inter,system-ui,Arial}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02)}
</style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">Deriv • Live 1-Tick Signals</h1>
        <div class="muted small">Dark UI — Over/Under + Even/Odd • 1-tick predictions</div>
      </div>
      <div class="flex items-center space-x-2">
        <div id="status" class="pill muted">Connecting...</div>
        <button id="adminBtn" class="px-3 py-1 bg-blue-600 rounded">Admin</button>
      </div>
    </header>

    <main class="grid grid-cols-3 gap-4">
      <section class="col-span-2">
        <div class="card rounded p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="muted small">Market</div>
              <select id="marketSel" class="p-2 rounded bg-transparent border border-white/5">
                <option>R_100</option><option>R_25</option><option>R_10</option><option>R_50</option>
              </select>
            </div>
            <div class="text-right">
              <div class="muted small">Last price</div>
              <div id="lastPrice" class="text-xl font-semibold">—</div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-2">
              <div class="muted small mb-2">Recent ticks</div>
              <div id="ticks" class="bg-black/20 rounded p-2 max-h-48 overflow-auto"></div>
            </div>

            <div class="card rounded p-3">
              <div class="muted small">Live Prediction</div>
              <div id="predType" class="text-xs muted mt-1">1-TICK</div>
              <div id="predMain" class="text-3xl font-extrabold mt-2">—</div>
              <div id="predMeta" class="muted small mt-2">Confidence: —</div>
              <div class="mt-3">
                <button id="markWin" class="w-full px-2 py-1 bg-green-600 rounded">Mark Win</button>
                <button id="markLoss" class="w-full px-2 py-1 bg-red-600 rounded mt-2">Mark Loss</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card rounded p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Signals History</h3>
            <div class="muted small">Total: <span id="total">0</span></div>
          </div>
          <ul id="history" class="space-y-2 max-h-60 overflow-auto"></ul>
        </div>
      </section>

      <aside>
        <div class="card rounded p-4 mb-4">
          <div class="muted small">Controls</div>
          <div class="mt-3 space-y-2">
            <button id="pauseBtn" class="w-full px-3 py-2 bg-yellow-600 rounded">Pause</button>
            <button id="clearHistory" class="w-full px-3 py-2 bg-red-600 rounded">Clear History</button>
            <button id="copyJson" class="w-full px-3 py-2 bg-indigo-600 rounded">Copy JSON</button>
          </div>
        </div>

        <div class="card rounded p-4">
          <div class="muted small">Filters</div>
          <label class="block mt-2 small muted">Min confidence</label>
          <input id="minConf" type="range" min="0" max="100" value="0" class="w-full" />
        </div>
      </aside>
    </main>
  </div>

  <!-- admin modal (simple) -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
    <div class="bg-[#071025] rounded-lg w-full max-w-xl p-4 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Admin • Simulate / Settings</h3>
        <button id="closeAdmin" class="px-2 py-1 bg-gray-700 rounded">Close</button>
      </div>
      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="muted small">Simulate tick price</label>
          <input id="simPrice" class="w-full p-2 rounded bg-transparent border border-white/5" placeholder="e.g. 12345.67" />
          <button id="simBtn" class="mt-2 w-full px-3 py-2 bg-green-600 rounded">Simulate</button>
        </div>
        <div>
          <label class="muted small">Set SYMBOL env (server must be redeployed)</label>
          <input id="setSym" class="w-full p-2 rounded bg-transparent border border-white/5" placeholder="R_100" />
          <div class="muted small mt-1">(Change server SYMBOL on host if needed)</div>
        </div>
      </div>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const socket = io(); // same origin
  const status = document.getElementById('status');
  const ticksEl = document.getElementById('ticks');
  const lastPrice = document.getElementById('lastPrice');
  const predMain = document.getElementById('predMain');
  const predMeta = document.getElementById('predMeta');
  const predType = document.getElementById('predType');
  const historyEl = document.getElementById('history');
  const totalEl = document.getElementById('total');
  const minConfEl = document.getElementById('minConf');

  let signals = [];

  socket.on('connect', ()=> {
    status.textContent = 'Live';
    status.className = 'pill';
  });
  socket.on('disconnect', ()=> {
    status.textContent = 'Disconnected';
    status.className = 'pill muted';
  });

  socket.on('tick', t => {
    // t: {ts, price, symbol}
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between py-1 px-2';
    div.innerHTML = `<div class="small muted">${new Date(t.ts).toLocaleTimeString()}</div><div>${t.price}</div>`;
    ticksEl.prepend(div);
    while (ticksEl.children.length > 50) ticksEl.removeChild(ticksEl.lastChild);
    lastPrice.textContent = t.price;
  });

  socket.on('signal', s => {
    // s.predictions.over_under.direction/confidence
    const ou = s.predictions.over_under;
    const eo = s.predictions.even_odd;
    if (ou && (ou.confidence*100) >= Number(minConfEl.value)) {
      predType.textContent = '1-TICK';
      predMain.textContent = ou.direction.toUpperCase();
      predMeta.textContent = `Conf: ${Math.round(ou.confidence*100)}% • Price: ${s.price}`;
    }
    // add to history
    signals.unshift(s);
    if (signals.length > 200) signals.pop();
    renderHistory();
  });

  function renderHistory(){
    historyEl.innerHTML = '';
    for (const s of signals.slice(0,200)){
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between p-2 bg-black/20 rounded';
      li.innerHTML = `<div><div class="text-sm font-semibold">${s.type} • ${s.predictions.over_under.direction.toUpperCase()}</div>
        <div class="muted small">${new Date(s.ts).toLocaleTimeString()}</div></div>
        <div class="muted small">${Math.round(s.predictions.over_under.confidence*100)}%</div>`;
      historyEl.appendChild(li);
    }
    totalEl.textContent = signals.length;
  }

  // admin UI
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminModal');
  const closeAdmin = document.getElementById('closeAdmin');
  const simBtn = document.getElementById('simBtn');
  const simPrice = document.getElementById('simPrice');

  adminBtn.addEventListener('click', ()=> adminModal.classList.remove('hidden'));
  closeAdmin.addEventListener('click', ()=> adminModal.classList.add('hidden'));

  simBtn.addEventListener('click', ()=>{
    const v = Number(simPrice.value);
    if (!v) return alert('Enter number');
    // post local fake tick to UI and treat it as if server sent it
    const fake = { ts: Date.now(), price: v, symbol: document.getElementById('marketSel').value };
    // render tick locally
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between py-1 px-2';
    div.innerHTML = `<div class="small muted">${new Date(fake.ts).toLocaleTimeString()}</div><div>${fake.price}</div>`;
    ticksEl.prepend(div);
    lastPrice.textContent = fake.price;
    // basic local prediction mimic (momentum light)
    const direction = Math.random()>0.5 ? 'OVER' : 'UNDER';
    predMain.textContent = direction;
    predMeta.textContent = `Simulated • Price: ${fake.price}`;
    // also add to local history
    const mock = {
      ts: Date.now(),
      type: 'sim',
      predictions: { over_under: { direction: direction.toLowerCase(), confidence: 0.6 } },
      price: fake.price
    };
    signals.unshift(mock);
    renderHistory();
    alert('Simulated tick added locally.');
  });

  // controls
  document.getElementById('pauseBtn').addEventListener('click', ()=>{
    const el = document.getElementById('pauseBtn');
    if (el.textContent === 'Pause') { el.textContent='Resume'; socket.disconnect(); } else { el.textContent='Pause'; socket.connect(); }
  });
  document.getElementById('clearHistory').addEventListener('click', ()=> { if (confirm('Clear history?')) { signals=[]; renderHistory(); }});
  document.getElementById('copyJson').addEventListener('click', async ()=> {
    try {
      await navigator.clipboard.writeText(JSON.stringify(signals, null, 2));
      alert('JSON copied to clipboard.');
    } catch(e){
      alert('Could not copy. Check permissions.');
    }
  });

})();
</script>
</body>
</html>
